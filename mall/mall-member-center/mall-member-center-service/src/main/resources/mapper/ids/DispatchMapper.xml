<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ibuscloud.ids.line.dao.DispatchDao">

    <resultMap id="DispatchMap" type="com.ibuscloud.ids.line.model.Dispatch">
        <result column="dispatch_leave_time" property="dispatchLeaveTime"/>
        <result column="driver_name" property="driver"/>
    </resultMap>

    <sql id="need_column">
        `bus_self_no`,
        `driver`
    </sql>

    <select id="getDispatchLeaveTimeById" resultMap="DispatchMap">
        SELECT
        dispatch_leave_time
        FROM intelligent_dispatch_new
        WHERE id = #{id};
    </select>

    <select id="getDriverByBusSelfNo" resultMap="DispatchMap">
        SELECT
        driver_name
        FROM intelligent_dispatch_new
        WHERE bus_self_no = #{busSelfNo} AND dispatch_leave_time = (SELECT MAX(dispatch_leave_time)
        FROM intelligent_dispatch_new WHERE dispatch_leave_time &lt; NOW() AND bus_self_no = #{busSelfNo});
    </select>

    <select id="findBusAlterationByRouteSelfNo" resultMap="DispatchMap">
        SELECT
        <include refid="need_column"/>
        FROM intelligent_dispatch_new
        WHERE route_no = #{routeSelfNo} AND date = #{date};
    </select>

    <select id="findAlterationCountByRouteSelfNo" resultMap="DispatchMap">
        SELECT
        COUNT(distinct bus_self_no)
        FROM intelligent_dispatch_new
        WHERE route_no = #{routeSelfNo} AND date = #{date} AND plan_leave_time is null;
    </select>

    <select id="findDispatchCountByRouteSelfNo" resultType="int">
        SELECT
        COUNT(distinct bus_self_no)
        FROM intelligent_dispatch_new
        WHERE route_no = #{routeSelfNo} AND date = #{date} AND plan_leave_time is not null;
    </select>

</mapper>

